---
import Base from "../layouts/Base.astro";
---

<Base>
	<div class="fixed top-0 right-0 bottom-0 left-0 flex text-[12px]">
		<div class="flex-[0_0_480px] p-1 border-r flex-col">
			<div class="h-full w-full flex flex-col">
				<div class="flex-[0_0_48px] flex justify-center items-center gap-x-10 border-b">
					<!-- <div x-data> -->
					<button x-data @click="$store.global.docsOpen = !$store.global.docsOpen;" class="btn" id="showdocs">ì„¤ëª…ì„œ ë³´ì—¬ì¤˜</button>
					<button x-data @click="findpath();" class="btn"">ìµœì ê²½ë¡œ ì°¾ì•„ì¤˜</button>
					<button x-data @click="$store.global.showDetail = !$store.global.showDetail;" class="btn" id="showoverlays">ë§ˆì»¤í‘œì‹œìì„¸íˆ</button>
				</div>
				<div x-data class="flex-[0_0_48px] flex gap-x-6 border-b">
					<div>
						<div>ê·¸ë£¹ ìˆ˜</div>
						<input id="countGoups" type="number" x-model.number="$store.global.countGroups" min="1" max="10" class="w-[64px] h-8 px-1 border border-gray-300 rounded text-center text-sm"/>
					</div>
					<div class="flex flex-wrap gap-x-6 items-center">
						<label x-data="{visible: true}"><input type="checkbox" alt="0" :checked="true" :disabled="$store.global.countGroups <= 0" @click="visible=!visible;toggle(0, visible);"><span>ê·¸ë£¹ 0</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="1" :checked="true" :disabled="$store.global.countGroups <= 1" @click="visible=!visible;toggle(1, visible);"><span>ê·¸ë£¹ 1</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="2" :checked="true" :disabled="$store.global.countGroups <= 2" @click="visible=!visible;toggle(2, visible);"><span>ê·¸ë£¹ 2</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="3" :checked="true" :disabled="$store.global.countGroups <= 3" @click="visible=!visible;toggle(3, visible);"><span>ê·¸ë£¹ 3</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="4" :checked="true" :disabled="$store.global.countGroups <= 4" @click="visible=!visible;toggle(4, visible);"><span>ê·¸ë£¹ 4</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="5" :checked="true" :disabled="$store.global.countGroups <= 5" @click="visible=!visible;toggle(5, visible);"><span>ê·¸ë£¹ 5</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="6" :checked="true" :disabled="$store.global.countGroups <= 6" @click="visible=!visible;toggle(6, visible);"><span>ê·¸ë£¹ 6</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="7" :checked="true" :disabled="$store.global.countGroups <= 7" @click="visible=!visible;toggle(7, visible);"><span>ê·¸ë£¹ 7</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="8" :checked="true" :disabled="$store.global.countGroups <= 8" @click="visible=!visible;toggle(8, visible);"><span>ê·¸ë£¹ 8</span></label>
						<label x-data="{visible: true}"><input type="checkbox" alt="9" :checked="true" :disabled="$store.global.countGroups <= 9" @click="visible=!visible;toggle(9, visible);"><span>ê·¸ë£¹ 9</span></label>
					</div>
				</div>
				<div class="flex-[0_0_32px]">
					<div class="inline">ğŸ“¢ </div>
					<div id="msg" class="inline">ì•ˆë…•í•˜ì„¸ìš”, D2Rì‚¬ì—…ë¶€ ë¹ ì´íŒ…!!</div>
				</div>
				<div class="flex-[1_0_0] overflow-auto">
					<div id="spreadsheet" class="w-full"></div>
				</div>
			</div>
		</div>
		<div class="flex-[1_0_0] basis-0 p-1 text-[12px]">
			<div x-data :class="$store.global.showDetail ? '' : 'hiddenoverlays';"></div>
			<div id="map" class="h-full w-full"></div>
		</div>
	</div>
	<div x-data :class="$store.global.docsOpen ? '' : 'hidden'" id="docs" class="fixed top-[60px] left-[2px] w-[480px] bg-white border-2 rounded z-[9999]">
		<ol>
			<li>ìœ„ ì²«ë²ˆì§¸ ì¹¸ì— ì¶œë°œì§€ì ì˜ "ì—…ì²´ëª…", "ì£¼ì†Œ" ì‚½ì…</li>
			<li>ë‘ë²ˆì§¸ ì¹¸ë¶€í„° ê°€ì•¼í•  ê³³ì„ ëœë¤í•˜ê²Œ ì‚½ì…(ì—‘ì…€ì—ì„œ ë³µ&ë¶™ í•˜ë©´ í¸í•¨)</li>
			<li>ì¶œë°œì§€ì  í¬í•¨ ìµœëŒ€ 15ê°œ ì…ë ¥ë§Œ ê°€ëŠ¥</li>
			<li>ì¢Œìƒë‹¨ ì¤‘ê°„ "ìµœì ê²½ë¡œ ì°¾ì•„ì¤˜" ë²„íŠ¼ í´ë¦­</li>
			<li><a href="https://namu.wiki/w/%EC%99%B8%ED%8C%90%EC%9B%90%20%EC%88%9C%ED%9A%8C%20%EB%AC%B8%EC%A0%9C">TSP</a> ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìµœì  ê²½ë¡œ íŒë‹¨(ì—…ì²´ëª… ë˜ëŠ” ì£¼ì†Œì¹¸ì´ ë¹„ì–´ìˆì„ ê²½ìš° ê·¸ ì¤„ì€ ë¬´ì‹œ)</li>
			<li>ì•„ë˜ í‘œì— ì¶œë°œì§€ì ë¶€í„° ë°©ë¬¸í•´ì•¼í•  ìˆœì„œëŒ€ë¡œ ì •ë ¬ë ¬ë¨</li>
			<li>ë§Œì¼, KAKAO ì§€ë„ì—ì„œ ì¸ì‹ëª»í•˜ëŠ” ì£¼ì†Œ ìˆì„ ê²½ìš°, ë¶‰ì€ê¸€ì”¨ë¡œ ì—ëŸ¬</li>
			<li>ìµœì ê²½ë¡œ ì°¾ìœ¼ë©´ ì§€ë„ì— ë°©ë¬¸ìˆœì„œëŒ€ë¡œ ë§ˆì»¤ê°€ í‘œì‹œë¨</li>
			<li>ì¢Œìƒë‹¨ ì˜¤ë¥¸ìª½ "ë§ˆì»¤í‘œì‹œìì„¸íˆ" ë²„íŠ¼ í´ë¦­í•˜ë©´ ë§ˆì»¤ì— ë¶€ê°€ì„¤ëª… í‘œì‹œë˜ê±°ë‚˜ ì‚¬ë¼ì§</li>
		</ol>
		<div class="mt-4 text-blue-600">
			ë‹¤ì‹œ "ì„¤ëª…ì„œ ë³´ì—¬ì¤˜" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ ì„¤ëª…ì„œê°€ ë‹«í™ë‹ˆë‹¤.
		</div>
	</div>
</Base>

<style is:global>
	.hiddenoverlays ~ #map .overlay {
		display: none !important;
	}
</style>

<script is:inline>

	// alpinejs ì „ì—­ë³€ìˆ˜ ì´ˆê¸°í™”
	document.addEventListener("alpine:init", () => {
		Alpine.store("global", {
			docsOpen: false,		// ì„¤ëª…ì„œ í† ê¸€
			showDetail: false,		// ë§ˆì»¤ ì„¸ë¶€ì‚¬í•­ í‘œì‹œ í† ê¸€
			countGroups: 7,			// mtps ì—ì„œ ì˜ì—…ì‚¬ì› ìˆ˜ ì´ˆê¸°ê°’
			get range() {			// countGoups ê°’ì— ë”°ë¼ ì¬ê³„ì‚° getter
				return Array.from({length: Math.min(10, Math.max(1, this.countGroups))}, (_, i) => i + 1);
			},
		});
	});

	// jspreadsheet ì´ˆê¸°í™”
	const MAX_ROWS = 100;
	const MAX_COLS = 3;
	const el = document.getElementById("spreadsheet");
	// const findpath = document.getElementById("findpath");
	const msg = document.getElementById("msg");
	

	const spreadsheet = jspreadsheet(el, {
		data: [],
		width: "100%",
		columns: [
			{ type: "text", title: "ì—…ì²´ëª…", width: 90 },
			{ type: "text", title: "ì£¼ì†Œ", width: el.clientWidth - 50 - 90 - 50 },
			{ type: "text", title: "ê·¸ë£¹", width: 50, readOnly: true }
		],
		minDimensions: [2, MAX_ROWS],
		contextmenu: {},
		onbeforeinsertrow: function (_instance, rows) {
			if (rows => MAX_ROWS - 1) return false;
		},
		onbeforeinsertcolumn: function (_instance, columns) {
			if (columns => MAX_COLS - 1) return false;
		},
		onbeforedeleterow: function (_instance, _rows) { return false; },
		onbeforedeletecolumn: function (_instance, _columns) { return false; },
	});

	const kakao_key = "5584c9f9d2b08e7975a38029e42d9790";
	const map = document.getElementById("map");
	const map_options = {
		center: new kakao.maps.LatLng(37.5820926424763, 126.888984720113),
		level: 7,
	};
	const kakao_map = new kakao.maps.Map(map, map_options);

	let markers = {}; // ë§ˆì»¤
	let paths = {}; // ê²½ë¡œì¶”ì  ë³´ì¡°
	let polylines = {}; // ê²½ë¡œí‘œì‹œ
	let overlays = {}; // ì˜¤ë²„ë ˆì´


	const toggle = (g, visible) => {
		markers[g]?.forEach((x) => x.setMap(visible ? kakao_map : null));
		polylines[g]?.setMap(visible ? kakao_map : null);
		overlays[g]?.forEach((x) => x.setMap(visible ? kakao_map : null));
	};

	//-> findpath
	const findpath = async (e) => {


		//--> ë³€ìˆ˜ ì´ˆê¸°í™”
		msg.innerHTML = "ì´ë™ê²½ë¡œ ì°¾ê¸° ì‹œì‘"; 
		let src = spreadsheet.getData();
		let tar = [];

		//--> ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
		try {
			const all_tr = el.querySelectorAll("table tbody tr");
			for (let x of all_tr) x.classList.remove("warn");
		} catch(e) {
			msg.innerHTML = "ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨";
			console.log(e);
			return;
		}
		
		//--> ì§€ë„ ì´ˆê¸°í™”
		try {
			for (let [g, sub] of Object.entries(markers)) sub.forEach((x) => x.setMap(null));
			for (let [g, sub] of Object.entries(polylines)) sub.setMap(null); //sub.forEach((y) => y.setMap(null));
			for (let [g, sub] of Object.entries(overlays)) sub.forEach((z) => z.setMap(null));
			markers = {};
			paths = {};
			polylines = {};
			overlays = {};
		} catch(e) {
			msg.innerHTML = "ì¹´ì¹´ì˜¤ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨";
			console.log(e);
			return;
		}

		//--> ì¢Œí‘œì°¾ê¸° api í˜¸ì¶œ í™”ë©´?
		let tail2 = ".";
		let interval2 = setInterval(() => {
			if (tail2.length % 10 === 0) {
				tail2 = ".";
			} else {
				tail2 += ".";
			}
			msg.innerHTML = "ì—…ì²´ëª… ì£¼ì†Œë¡œ ì¢Œí‘œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤" + tail2;
		}, 500);

		//--> ì£¼ì†Œ->ì¢Œí‘œ
		try {
			for (let [i, [name, addr, _]] of src.entries()) {
				if (name.trim().length === 0 || addr.trim().length === 0) continue;

				let res = await fetch(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(addr)}`, {
					method: "GET",
					headers: { 
						Authorization: `KakaoAK ${kakao_key}`,
					}
				});
				let obj = await res.json();

				tar.push({
					i,
					name,
					addr,
					lng: +obj?.documents?.[0]?.x,
					lat: +obj?.documents?.[0]?.y,
					g: 0,
				});
			}
		} catch(e) {
			clearInterval(interval2);
			msg.innerHTML = "ì¹´ì¹´ì˜¤ì§€ë„ API í˜¸ì¶œ ì‹¤íŒ¨";
			console.log(e);
			return;
		}
		clearInterval(interval2);

		//--> ì¢Œí‘œ ê²€ì¦
		try {
			let is_err = false;

			for (let { i, lng } of tar) {
				if (!lng) {
					is_err = true;
					el.querySelector(`table tbody tr[data-y="${i}"]`).classList.add("warn");
				}
			}

			if (is_err) throw new Error("ì£¼ì†Œ ì˜¤ë¥˜");

		} catch(e) {
			msg.innerHTML = "ì¹´ì¹´ì˜¤ì§€ë„ API ì£¼ì†Œ ì¸ì‹ ì‹¤íŒ¨ (ì•„ë˜ ë¶‰ì€ìƒ‰ í‘œì‹œ ë¶€ë¶„ í™•ì¸í•´ì£¼ì„¸ìš”.)";
			console.log(e);
			return;
		}

		//--> tar ë°°ì—´ì´ ë¹„ì–´ìˆë‹¤ë©´ ê·¸ëƒ¥ ì¢…ë£Œ
		if (tar.length === 0) {
			msg.innerHTML = "ë™ì„ ì„ ì¶”ì í•  ì—…ì²´ëª…, ì£¼ì†Œ ì—†ìŒ";
			console.log(e);
			return ;
		}

		//--> ìµœì  ê²½ë¡œ ì°¾ê¸° ë¡œë”©í™”ë©´?
		let tail = ".";
		let interval = setInterval(() => {
			if (tail.length % 10 === 0) {
				tail = ".";
			} else {
				tail += ".";
			}
			msg.innerHTML = "ìµœì  ê²½ë¡œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤" + tail;
		}, 500);

		//--> ë¹„ë™ê¸°ë¡œ mtsp ì•Œê³ ë¦¬ì¦˜ ì‹¤í–‰
		(async () => {

			let data = {
				items: tar,
				k: +document.querySelector("#countGoups").value, //Alpine.store("global").countGroups,
			};

			//---> Deno mtsp API í˜¸ì¶œí•˜ì—¬ mtsp ì•Œê³ ë¦¬ì¦˜ ì ìš©
			try {
				let res = await fetch("https://ezapi.ehzilehzil.deno.net/mtsp", {
					method: "POST",
					headers: { 
						"Content-Type": "application/json",
					},
					body: JSON.stringify(data),
				});
				if (!res.ok) throw new Error();

				tar = await res.json();
			} catch(e) {
				msg.innerHTML = "Deno mtsp API í˜¸ì¶œ ì‹¤íŒ¨";
				console.log(e);
				return;
			}

			//--> ìµœì ê²½ë¡œë¥¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë‹¤ì‹œ í‘œì‹œ
			try {
				spreadsheet.setData(tar.map((x) => [x.name, x.addr, x.g]));
			} catch(e) {
				msg.innerHTML = "ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ê¸°ìˆ ì  ë¬¸ì œ ë°œìƒ";
				console.log(e);
				return;
			}

			//--> ì´ë™ê²½ë¡œ ì¶”ì 
			let by_g;
			try {
				by_g = tar.reduce((a, x) => {
					(a[x.g] ||= []).push(x);
					return a;
				}, {});

				for (let [g, sub_tar] of Object.entries(by_g)) {
					if (sub_tar.length === 0) continue;

					if (sub_tar.length <= 30) {
						let res = await fetch('https://apis-navi.kakaomobility.com/v1/waypoints/directions', {
							method: 'POST',
							headers: {
								'Authorization': `KakaoAK ${kakao_key}`,
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								origin: { x: sub_tar[0].lng, y: sub_tar[0].lat },
								destination: { x: sub_tar[sub_tar.length - 1].lng, y: sub_tar[sub_tar.length - 1].lat },
								waypoints: sub_tar.map((x) => ({ x: x.lng, y: x.lat })).slice(1, -1),
								priority: "RECOMMEND"
							}),
						});
						// console.log(res);
						let obj = await res.json();

						let tmp = collectValuesByKey(obj, "vertexes");
						tmp = tmp.flat(Infinity);
						for (let i = 0; i < tmp.length; i += 2) {

							(paths[g] ||= []).push(new kakao.maps.LatLng(tmp[i + 1], tmp[i]));
							
						}
					} else {
						let max_index = sub_tar.length - 1;
						let fromTo = [
							[0, 29], [29, 58], [58, 87], [87, 116]
						];
						for (let [from, to] of fromTo) {
							let isDone = false;
							if (max_index <= to) {
								to = max_index;
								isDone = true;
							}
						
							let res = await fetch('https://apis-navi.kakaomobility.com/v1/waypoints/directions', {
								method: 'POST',
								headers: {
									'Authorization': `KakaoAK ${kakao_key}`,
									'Content-Type': 'application/json'
								},
								body: JSON.stringify({
									origin: { x: sub_tar[from].lng, y: sub_tar[from].lat },
									destination: { x: sub_tar[to].lng, y: sub_tar[to].lat },
									waypoints: sub_tar.slice(from+1, to-1).map((x) => ({ x: x.lng, y: x.lat })),
									priority: "RECOMMEND"
								}),
							});
							// console.log(res);
							let obj = await res.json();

							let tmp = collectValuesByKey(obj, "vertexes");
							tmp = tmp.flat(Infinity);
							for (let i = 0; i < tmp.length; i += 2) {

								(paths[g] ||= []).push(new kakao.maps.LatLng(tmp[i + 1], tmp[i]));
								
							}



							if (isDone) break;
						}
					}
				}
			} catch(e) {
				msg.innerHTML = "ì¹´ì¹´ì˜¤ì§€ë„ ê²½ë¡œì°¾ê¸° APIì— ê¸°ìˆ ì  ë¬¸ì œ ë°œìƒ";
				console.log(e);
				return;
			}

			//--> ì¹´ì¹´ì˜¤ì§€ë„ì— ë§ˆì»¤+ì´ë™ê²½ë¡œ+ì˜¤ë²„ë ˆì´ í‘œì‹œ
			try {
				kakao_map.panTo(new kakao.maps.LatLng(tar[0].lat, tar[0].lng));

				
				for (let [g, sub_tar] of Object.entries(by_g)) {
					if (sub_tar.length === 0) continue;

					let i = 1;

					markers[g] = sub_tar.map((x) => new kakao.maps.Marker({
						map: kakao_map,
						position: new kakao.maps.LatLng(x.lat, x.lng),
						image: new kakao.maps.MarkerImage(marker_image(i++, g), new kakao.maps.Size(32, 32)),
					}));

					// console.log(sub_tar);

					polylines[g] = new kakao.maps.Polyline({
						map: kakao_map,
						path: paths[g],
						strokeWidth: 5,
						strokeColor: "#000000",
						strokeStyle: "solid",
						strokeOpacity: 0.6,
					});

					overlays[g] = sub_tar.map((x) => {
						let content = `<div class="overlay\" style="background:rgba(255,255,255,0.9); border-radius:4px; border:1px solid; padding:0 2px;">`;
						content += `${x.name}<br/>${x.addr}`;
						content += `</div>`;

						return new kakao.maps.CustomOverlay({
							map: kakao_map,
							position: new kakao.maps.LatLng(x.lat, x.lng),
							content: content,
							xAnchor: 0,
							yAnchor: 0.1,
							// zIndex: 9999,
						});
					});
				}
			} catch(e) {
				msg.innerHTML = "ì¹´ì¹´ì˜¤ì§€ë„ ìœ„ì— ë§ˆì»¤ ë“± í‘œì‹œì— ê¸°ìˆ ì  ë¬¸ì œ ë°œìƒ";
				console.log(e);
				return;
			}

			msg.innerHTML = "ì´ë™ê²½ë¡œì°¾ê¸° ì¢…ë£Œ";

			console.log(polylines);

		})().finally(() => {
			clearInterval(interval);
		});

		
	}

	function marker_image(i, g) {
		let colors = [
			"rgba(0,255,0,0.7)",
			"rgba(255,0,0,0.7)",
			"rgba(0,0,255,0.7)",
			"rgba(255,255,0,0.7)",
			"rgba(0,255,255,0.7)",
			"rgba(255,0,255,0.7)",
			"rgba(127,255,0,0.7)",
			"rgba(127,127,127,0.7)",
			"rgba(0,255,127,0.7)",
			"rgba(0,127,255,0.7)",
		];
		return 'data:image/svg+xml,' + encodeURIComponent(
			`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cy='50' cx='50' r='50' stroke-width='0' stroke='#000' fill='${colors[g]}'/>
				<text x="51" y="45" font-size="80" text-anchor="middle" alignment-baseline="central" fill="#000">
					${i}
				</text>	
			</svg>`
		);
	}
</script>
