---
import Base from "../layouts/Base.astro";
---

<Base>
	<div class="fixed top-0 right-0 bottom-0 left-0 flex text-[12px]">
		<div class="flex-none basis-[480px] p-1 border-r flex-col">
			<div class="h-full w-full overflow-auto">
				<div class="flex-none basis-[120px] flex justify-center items-center gap-x-10">
					<!-- <div x-data> -->
					<button x-data @click="$store.global.docsOpen = !$store.global.docsOpen;" class="btn" id="showdocs">ì„¤ëª…ì„œ ë³´ì—¬ì¤˜</button>
					<button class="btn" id="findpath">ìµœì ê²½ë¡œ ì°¾ì•„ì¤˜</button>
					<button x-data @click="$store.global.showDetail = !$store.global.showDetail;" class="btn" id="showoverlays">ë§ˆì»¤í‘œì‹œìì„¸íˆ</button>
				</div>
				<div class="h-8 my-2">
					<div class="inline">ğŸ“¢ </div>
					<div id="msg" class="inline">ì•ˆë…•í•˜ì„¸ìš”, D2Rì‚¬ì—…ë¶€ ë¹ ì´íŒ…!!</div>
				</div>
				<div id="spreadsheet" class="w-full"></div>
			</div>
		</div>
		<div class="grow shrink-0 basis-0 p-1 text-[12px]">
			<div x-data :class="$store.global.showDetail ? '' : 'hiddenoverlays';"></div>
			<div id="map" class="h-full w-full"></div>
		</div>
	</div>
	<div x-data :class="$store.global.docsOpen ? '' : 'hidden'" id="docs" class="fixed top-[60px] left-[2px] w-[480px] bg-white border-2 rounded z-[9999]">
		<ol>
			<li>ìœ„ ì²«ë²ˆì§¸ ì¹¸ì— ì¶œë°œì§€ì ì˜ "ì—…ì²´ëª…", "ì£¼ì†Œ" ì‚½ì…</li>
			<li>ë‘ë²ˆì§¸ ì¹¸ë¶€í„° ê°€ì•¼í•  ê³³ì„ ëœë¤í•˜ê²Œ ì‚½ì…(ì—‘ì…€ì—ì„œ ë³µ&ë¶™ í•˜ë©´ í¸í•¨)</li>
			<li>ì¶œë°œì§€ì  í¬í•¨ ìµœëŒ€ 15ê°œ ì…ë ¥ë§Œ ê°€ëŠ¥</li>
			<li>ì¢Œìƒë‹¨ ì¤‘ê°„ "ìµœì ê²½ë¡œ ì°¾ì•„ì¤˜" ë²„íŠ¼ í´ë¦­</li>
			<li><a href="https://namu.wiki/w/%EC%99%B8%ED%8C%90%EC%9B%90%20%EC%88%9C%ED%9A%8C%20%EB%AC%B8%EC%A0%9C">TSP</a> ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ìµœì  ê²½ë¡œ íŒë‹¨(ì—…ì²´ëª… ë˜ëŠ” ì£¼ì†Œì¹¸ì´ ë¹„ì–´ìˆì„ ê²½ìš° ê·¸ ì¤„ì€ ë¬´ì‹œ)</li>
			<li>ì•„ë˜ í‘œì— ì¶œë°œì§€ì ë¶€í„° ë°©ë¬¸í•´ì•¼í•  ìˆœì„œëŒ€ë¡œ ì •ë ¬ë ¬ë¨</li>
			<li>ë§Œì¼, KAKAO ì§€ë„ì—ì„œ ì¸ì‹ëª»í•˜ëŠ” ì£¼ì†Œ ìˆì„ ê²½ìš°, ë¶‰ì€ê¸€ì”¨ë¡œ ì—ëŸ¬</li>
			<li>ìµœì ê²½ë¡œ ì°¾ìœ¼ë©´ ì§€ë„ì— ë°©ë¬¸ìˆœì„œëŒ€ë¡œ ë§ˆì»¤ê°€ í‘œì‹œë¨</li>
			<li>ì¢Œìƒë‹¨ ì˜¤ë¥¸ìª½ "ë§ˆì»¤í‘œì‹œìì„¸íˆ" ë²„íŠ¼ í´ë¦­í•˜ë©´ ë§ˆì»¤ì— ë¶€ê°€ì„¤ëª… í‘œì‹œë˜ê±°ë‚˜ ì‚¬ë¼ì§</li>
		</ol>
		<div class="mt-4 text-blue-600">
			ë‹¤ì‹œ "ì„¤ëª…ì„œ ë³´ì—¬ì¤˜" ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ ì„¤ëª…ì„œê°€ ë‹«í™ë‹ˆë‹¤.
		</div>
	</div>
</Base>

<style is:global>
	.hiddenoverlays ~ #map .overlay {
		display: none !important;
	}
</style>

<script is:inline>
	// const $showdocs = document.querySelector("#showdocs");
	// const $docs = document.querySelector("#docs");
	// $showdocs.onclick = (e) => {
	// 	$docs.classList.toggle("hidden");
	// };

	// const $showoverlays = document.querySelector("#showoverlays");
	// $showoverlays.onclick = (e) => {
	// 	const $overlays = document.querySelectorAll(".overlay");
	// 	if ($overlays.length > 0) {
	// 		document.body.classList.toggle("hiddenoverlays");
	// 	}
	// 	// for (let i = 0; i < $overlays.length; i++) {
	// 	// 	$overlays[i].classList.toggle("hidden");
	// 	// }
	// };
	

	const MAX_ROWS = 30;
	const MAX_COLS = 2;
	const el = document.getElementById("spreadsheet");
	const findpath = document.getElementById("findpath");
	const msg = document.getElementById("msg");
	const kakao_key = "5584c9f9d2b08e7975a38029e42d9790";

	const spreadsheet = jspreadsheet(el, {
		data: [],
		width: "100%",
		columns: [
			{ type: "text", title: "ì—…ì²´ëª…", width: 90 },
			{ type: "text", title: "ì£¼ì†Œ", width: el.clientWidth - 50 - 90 },
		],
		minDimensions: [2, MAX_ROWS],
		contextmenu: {},
		onbeforeinsertrow: function (_instance, rows) {
			if (rows => MAX_ROWS - 1) return false;
		},
		onbeforeinsertcolumn: function (_instance, columns) {
			if (columns => MAX_COLS - 1) return false;
		},
		onbeforedeleterow: function (_instance, _rows) { return false; },
		onbeforedeletecolumn: function (_instance, _columns) { return false; },
	});

	const map = document.getElementById("map");
	let markers = []; // ì§€ë„ ë§ˆì»¤ë“¤
	let routing = []; // ì´ë™ê²½ë¡œ ì¢Œí‘œë“¤
	let polyline = undefined; // ì´ë™ê²½ë¡œ ì¢Œí‘œë“¤ë¡œ ë§Œë“  ì§€ë„ í‘œì‹œìš© ê°ì²´
	const map_options = {
		center: new kakao.maps.LatLng(37.5820926424763, 126.888984720113),
		level: 7,
	};
	const kakao_map = new kakao.maps.Map(map, map_options);

	
	findpath.onclick = async (e) => {
		msg.innerHTML = "";
		let src = spreadsheet.getData();
		let tar = [];

		// ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
		try {
			const all_tr = el.querySelectorAll("table tbody tr");
			for (let x of all_tr) x.classList.remove("warn");
		} catch(e) {
			msg.innerHTML = "ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ê¸°ìˆ ì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
			console.log(e);
			return;
		}

		// ì§€ë„ ì´ˆê¸°í™” (ê¸°ì¡´ ë§ˆì»¤, ì´ë™ê²½ë¡œ ì‚­ì œ)
		try {
			markers.forEach((marker) => { marker.setMap(null); });
			polyline?.setMap(null);
			polyline = undefined;
			routing = [];
		} catch(e) {
			msg.innerHTML = "ê¸°ì¡´ ë§ˆì»¤/ì´ë™ê²½ë¡œ ì‚­ì œí•˜ëŠ” ê³¼ì •ì—ì„œ ê¸°ìˆ ì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
			console.log(e);
			return;
		}
		
		// ì£¼ì†Œ->ì¢Œí‘œ ë³€í™˜
		try {
			for (let [i, [x, y]] of src.entries()) {
				if (x.trim().length === 0 || y.trim().length === 0) continue;

				let res = await fetch(`https://dapi.kakao.com/v2/local/search/address.json?query=${encodeURIComponent(y)}`, {
					method: "GET",
					headers: {
						Authorization: `KakaoAK ${kakao_key}`,
					}
				});
				let obj = await res.json();

				tar.push([i, x, y, obj?.documents?.[0]?.x, obj?.documents?.[0]?.y]);
			}
		} catch(e) {
			msg.innerHTML = "ì£¼ì†Œ->ì¢Œí‘œ ë³€í™˜í•˜ëŠ” KAKAO MAP APIì— ë­”ê°€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.";
			console.log(e);
			return;
		}

		// ë³€í™˜ëœ ì¢Œí‘œì— ë¬¸ì œê°€ ì—†ëŠ”ì§€ ê²€ì‚¬
		try {
			let is_err = false;

			for (let [i, _x, _y, z, _w] of tar) {
				if (z === undefined) {
					is_err = true;
					el.querySelector(`table tbody tr[data-y="${i}"]`).classList.add("warn");
				}
			}

			if (is_err) throw new Error("ì£¼ì†Œ ì˜¤ë¥˜");

		} catch(e) {
			msg.innerHTML = "ì¹´ì¹´ì˜¤ ì§€ë„ê°€ ì¸ì‹ì„ ëª»í•˜ëŠ” ì£¼ì†Œê°€ ìˆì–´ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.";
			console.log(e);
			return;
		}


		// tar ë°°ì—´ì— ì•„ë¬´ê²ƒë„ ì—†ë‹¤ë©´ ê·¸ëƒ¥ ì¢…ë£Œ
		if (tar.length === 0) {
			msg.innerHTML = "ë™ì„ ì„ ì¶”ì í•  ì—…ì²´ëª…ê³¼ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.";
			return;
		} 



		// TSP ì•Œê³ ë¦¬ì¦˜ ì ìš©
		try {

			msg.innerHTML = "ìµœì  ê²½ë¡œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤....";

			tar = solveTSP(tar);
			// console.log(tar);
			// console.log(res);
		} catch(e) {
			msg.innerHTML = "TSP ì•Œê³ ë¦¬ì¦˜ ì ìš©ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤.";
			console.log(e);
			return;
		}

		// ìµœì ê²½ë¡œë¥¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë‹¤ì‹œ í‘œì‹œ
		try {
			spreadsheet.setData(tar.map(([_i, a, b, _x, _y]) => [a, b]));

			msg.innerHTML = "ìµœì  ê²½ë¡œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. ìœ„ë¶€í„° ìˆœì„œëŒ€ë¡œ ë°©ë¬¸í•˜ë©´ ë©ë‹ˆë‹¤.";
		} catch(e) {
			msg.innerHTML = "ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ê¸°ìˆ ì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
			console.log(e);
			return;
		}
		
		// ì‹¤ì œ ì´ë™ ê²½ë¡œ ì¶”ì 
		try {
			const body = {
				origin: { x: tar[0][3], y: tar[0][4] },
				destination: { x: tar[tar.length - 1][3], y: tar[tar.length - 1][4] },
				waypoints: tar.map(([_i, a, _b, x, y]) => ({ name: a, x: x, y: y })).slice(1, -1),
				priority: "RECOMMEND"
			};

			let res = await fetch('https://apis-navi.kakaomobility.com/v1/waypoints/directions', {
				method: 'POST',
				headers: {
					'Authorization': `KakaoAK ${kakao_key}`,
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(body)
			});
			let obj = await res.json();

			// console.log(obj);

			let tmp = collectValuesByKey(obj, "vertexes");
			tmp = tmp.flat(Infinity);
			for (let i = 0; i < tmp.length; i += 2) {
				routing.push(new kakao.maps.LatLng(tmp[i + 1], tmp[i]));
			}
			
		} catch(e) {
			msg.innerHTML = "ì¹´ì¹´ì˜¤ ì§€ë„ ì´ë™ ê²½ë¡œ API ì— ê¸°ìˆ ì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
			console.log(e);
			return;
		}

		// ì§€ë„ì— ë§ˆì»¤/ì´ë™ê²½ë¡œ í‘œì‹œ
		try {
			kakao_map.panTo(new kakao.maps.LatLng(tar[0][4], tar[0][3]));

			markers = tar.map(([_i, a, b, x, y], i) => new kakao.maps.Marker({
				map: kakao_map,
				position: new kakao.maps.LatLng(y, x),
				// title: a + "\n" + b,
				// image: new kakao.maps.MarkerImage(marker_image(tag), new kakao.maps.Size(icon_size, icon_size)),
				image: new kakao.maps.MarkerImage(marker_image(i), new kakao.maps.Size(32, 32)),
			}));

			polyline = new kakao.maps.Polyline({
				map: kakao_map,
				path: routing,
				strokeWidth: 5,
				strokeColor: "#000000",
				strokeStyle: "solid",
				strokeOpacity: 0.6,
			});

			tar.forEach(([i, a, b, x, y]) => {
				let content = `<div class="overlay\" style="background:rgba(255,255,255,0.9); border-radius:4px; border:1px solid; padding:0 2px;">`;
				content += `${a}<br/>${b}`;
				content += `</div>`;

				let overlay = new kakao.maps.CustomOverlay({
					map: kakao_map,
					position: new kakao.maps.LatLng(y, x),
					content: content,
					xAnchor: 0,
					yAnchor: 0.1,
					// zIndex: 9999,
				});
			});

			
			

		} catch(e) {
			msg.innerHTML = "ì¹´ì¹´ì˜¤ ì§€ë„ ì´ë™ ê²½ë¡œ ì§€ë„ í‘œì‹œì— ê¸°ìˆ ì ì¸ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
			console.log(e);
			return;
		}
	};

	function marker_image(i) {
		return 'data:image/svg+xml,' + encodeURIComponent(
			`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cy='50' cx='50' r='50' stroke-width='0' stroke='#000' fill='rgba(0,255,0,0.7)'/>
				<text x="51" y="45" font-size="80" text-anchor="middle" alignment-baseline="central" fill="#000">
					${i + 1}
				</text>	
			</svg>`
		);
	}
	
	
</script>